# 常见问题与解决方案

<cite>
**本文档引用的文件**  
- [TextExtractHelper.cs](file://PdfHelperLibrary/TextExtractHelper.cs)
- [TableExtractHelper.cs](file://PdfHelperLibrary/TableExtractHelper.cs)
- [PdfTextExtracter.axaml.cs](file://PdfToolX/PdfTextExtracter.axaml.cs)
- [PdfTextExtractor.cs](file://_obsolete/PdfTool/PdfHelper/PdfTextExtractor.cs)
- [ProtectHelper.cs](file://PdfHelperLibrary/ProtectHelper.cs)
</cite>

## 目录
1. [文本乱序问题](#文本乱序问题)
2. [特殊符号丢失或乱码](#特殊符号丢失或乱码)
3. [加密PDF访问异常](#加密pdf访问异常)
4. [表格文本提取错乱](#表格文本提取错乱)
5. [日志输出与调试技巧](#日志输出与调试技巧)

## 文本乱序问题

在使用PdfPig进行PDF文本提取时，可能会遇到解析顺序与视觉阅读顺序不一致的问题。这是因为PdfPig按照PDF内部对象的存储顺序提取文本，而非人类阅读的从左到右、从上到下的顺序。

解决方案包括：
- 启用布局分析模式，通过更智能的文本块识别来重构阅读顺序
- 调整字符排序阈值，优化文本重组算法
- 使用`GetWords()`方法获取单词级位置信息，然后根据坐标手动重组文本流

**Section sources**
- [TextExtractHelper.cs](file://PdfHelperLibrary/TextExtractHelper.cs#L1-L34)

## 特殊符号丢失或乱码

特殊符号丢失或乱码现象通常由以下原因导致：
- PDF文档使用了未嵌入的自定义字体
- 编码设置不正确，无法正确解析Unicode字符
- 字符映射表缺失或损坏

建议的解决方案：
- 检查文档的编码设置，确保使用正确的字符编码
- 确认字体是否已嵌入PDF文件中
- 使用`GetWords()`方法获取更精确的字符位置信息，然后进行手动重组和修正
- 对于复杂符号，考虑使用字形级别的提取而非文本级别的提取

**Section sources**
- [TextExtractHelper.cs](file://PdfHelperLibrary/TextExtractHelper.cs#L22-L28)

## 加密PDF访问异常

处理加密PDF时可能出现访问异常，导致无法正常读取文档内容。这通常是因为文档设置了打开密码或所有者密码保护。

解决方案：
- 预先解密文档，使用正确的密码打开受保护的PDF文件
- 在调用`PdfDocument.Open()`方法时提供密码参数
- 对于需要批量处理的场景，实现密码管理机制

在项目中，`ProtectHelper.cs`文件提供了PDF保护和解除保护的相关功能，可参考其实现来处理加密文档。

**Section sources**
- [ProtectHelper.cs](file://PdfHelperLibrary/ProtectHelper.cs#L30-L56)

## 表格文本提取错乱

表格内文本提取错乱是常见的问题，主要表现为：
- 单元格内容错位
- 表格结构识别错误
- 跨行跨列单元格处理不当

建议的解决方案：
- 结合`TableExtractHelper`进行结构化提取，该类专门用于处理表格数据
- 使用基于表格线检测的算法来准确识别表格边界
- 对提取结果进行后处理，根据坐标信息重新构建表格结构
- 对于复杂表格，考虑使用专门的表格识别库

`TableExtractHelper`类使用`SpreadsheetExtractionAlgorithm`算法来提取表格，能够更好地保持表格的结构完整性。

**Section sources**
- [TableExtractHelper.cs](file://PdfHelperLibrary/TableExtractHelper.cs#L35-L67)

## 日志输出与调试技巧

在调试PDF文本提取问题时，有效的日志输出至关重要。项目中已实现了一些有用的调试技巧：

- 启用DEBUG模式查看单词级输出：在`TextExtractHelper.cs`中，使用`#if DEBUG`预处理器指令，在调试模式下输出每个单词的内容，便于分析提取过程
- 记录错误信息模式：捕获并记录异常信息，帮助识别问题根源
- 可视化调试：通过坐标信息可视化文本元素的位置，帮助理解布局问题

在`PdfTextExtracter.axaml.cs`中，实现了完整的用户界面日志输出功能，将提取过程和结果输出到文本框中，便于用户监控和调试。

**Section sources**
- [TextExtractHelper.cs](file://PdfHelperLibrary/TextExtractHelper.cs#L25-L27)
- [PdfTextExtracter.axaml.cs](file://PdfToolX/PdfTextExtracter.axaml.cs#L50-L52)