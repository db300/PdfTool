# 尤克里里乐谱编辑器

<cite>
**本文引用的文件**
- [MainForm.cs](file://UkuleleEditor/MainForm.cs)
- [MainForm.Designer.cs](file://UkuleleEditor/MainForm.Designer.cs)
- [Program.cs](file://UkuleleEditor/Program.cs)
- [SheetMusicItem.cs](file://UkuleleEditor/SheetMusicItem.cs)
- [SheetMusicRenderer.cs](file://UkuleleEditor/SheetMusicRenderer.cs)
- [UkuleleEditor.csproj](file://UkuleleEditor/UkuleleEditor.csproj)
- [test.json](file://UkuleleEditor/Tests/test.json)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本项目是一个基于 Windows Forms 的尤克里里乐谱编辑器，核心功能是将 JSON 格式的乐谱数据渲染为图片输出。程序通过解析包含多行音符信息的 JSON 文件，每行由若干“音符项”组成，每个音符项包含弦号、品号与可选歌词；渲染器会根据这些数据绘制四线谱网格、品位数字以及统一的歌词基线，并最终保存为图像文件。项目当前处于基础实现阶段，具备最小可用功能：读取测试数据、渲染并导出图片。

## 项目结构
- UkuleleEditor：主应用工程，包含窗体入口、渲染器与数据模型。
- Tests：包含默认测试数据文件，演示如何组织乐谱行与音符项。
- 依赖：使用 .NET 8、Windows Forms、System.Text.Json 进行序列化与绘图。

```mermaid
graph TB
subgraph "UkuleleEditor 工程"
MainForm["MainForm<br/>窗体入口"]
Program["Program<br/>应用入口"]
Renderer["SheetMusicRenderer<br/>渲染器"]
Model["SheetMusicItem<br/>数据模型"]
TestJson["Tests/test.json<br/>示例数据"]
end
Program --> MainForm
MainForm --> Renderer
Renderer --> Model
Renderer --> TestJson
```

图表来源
- [MainForm.cs](file://UkuleleEditor/MainForm.cs#L1-L24)
- [Program.cs](file://UkuleleEditor/Program.cs#L1-L17)
- [SheetMusicRenderer.cs](file://UkuleleEditor/SheetMusicRenderer.cs#L1-L145)
- [SheetMusicItem.cs](file://UkuleleEditor/SheetMusicItem.cs#L1-L50)
- [test.json](file://UkuleleEditor/Tests/test.json#L1-L112)

章节来源
- [UkuleleEditor.csproj](file://UkuleleEditor/UkuleleEditor.csproj#L1-L24)

## 核心组件
- 数据模型
  - SheetMusic：包含多行曲谱行集合。
  - SheetMusicLine：包含一组音符项。
  - SheetMusicItem：包含弦号、品号与可选歌词。
- 渲染器
  - SheetMusicRenderer：负责将 JSON 数据转换为位图图像，绘制四线谱网格、品位数字与统一歌词基线。
- 应用入口
  - Program：设置高 DPI 与默认字体后启动主窗体。
  - MainForm：初始化窗体标题并触发一次渲染流程，将结果保存为图片文件。

章节来源
- [SheetMusicItem.cs](file://UkuleleEditor/SheetMusicItem.cs#L1-L50)
- [SheetMusicRenderer.cs](file://UkuleleEditor/SheetMusicRenderer.cs#L1-L145)
- [Program.cs](file://UkuleleEditor/Program.cs#L1-L17)
- [MainForm.cs](file://UkuleleEditor/MainForm.cs#L1-L24)

## 架构总览
渲染流程自上而下的调用链如下：
- Program 启动应用并创建 MainForm。
- MainForm 初始化窗体并调用 SheetMusicRenderer.RenderSheetMusic 加载测试 JSON 并渲染。
- 渲染器解析 JSON，遍历各行与音符项，计算布局尺寸，绘制四线谱网格与品位数字，并在统一歌词基线绘制歌词。
- 最终返回位图并保存为图片文件。

```mermaid
sequenceDiagram
participant App as "Program"
participant UI as "MainForm"
participant R as "SheetMusicRenderer"
participant FS as "文件系统"
participant IMG as "图像输出"
App->>UI : 创建并运行主窗体
UI->>R : RenderSheetMusic("Tests/test.json")
R->>FS : 读取 JSON 文件
FS-->>R : 返回 JSON 文本
R->>R : 反序列化为 SheetMusic 对象
R->>R : 计算布局尺寸与绘制参数
R->>R : 绘制四线谱网格
R->>R : 绘制品位数字与歌词
R-->>UI : 返回 Bitmap
UI->>IMG : 保存为图片文件
```

图表来源
- [Program.cs](file://UkuleleEditor/Program.cs#L1-L17)
- [MainForm.cs](file://UkuleleEditor/MainForm.cs#L1-L24)
- [SheetMusicRenderer.cs](file://UkuleleEditor/SheetMusicRenderer.cs#L1-L145)
- [test.json](file://UkuleleEditor/Tests/test.json#L1-L112)

## 详细组件分析

### 数据模型：SheetMusicItem、SheetMusicLine、SheetMusic
- 设计要点
  - 使用内部类封装数据结构，避免对外暴露。
  - 采用列表容器承载行与音符项，便于扩展。
  - 字段包含弦号、品号与可选歌词，满足基本乐谱需求。
- 复杂度与性能
  - 结构简单，序列化/反序列化成本低。
  - 遍历渲染时按行与项线性处理，时间复杂度 O(N)（N 为音符总数）。
- 错误处理
  - 渲染器对空数据进行显式检查并抛出异常，避免无效输出。

```mermaid
classDiagram
class SheetMusic {
+SheetMusicLine[] Lines
}
class SheetMusicLine {
+SheetMusicItem[] Items
}
class SheetMusicItem {
+int String
+int Fret
+string Lyric
}
SheetMusic --> SheetMusicLine : "包含"
SheetMusicLine --> SheetMusicItem : "包含"
```

图表来源
- [SheetMusicItem.cs](file://UkuleleEditor/SheetMusicItem.cs#L1-L50)

章节来源
- [SheetMusicItem.cs](file://UkuleleEditor/SheetMusicItem.cs#L1-L50)

### 渲染器：SheetMusicRenderer
- 功能职责
  - 读取 JSON 文件并反序列化为数据模型。
  - 计算画布尺寸：根据行内音符数量确定行宽，按行数与行间距确定总高度。
  - 绘制四线谱网格：每行固定 4 根弦，等间距排列。
  - 绘制品位数字：每个音符项在其对应弦的中心位置绘制品号。
  - 绘制统一歌词基线：所有歌词在同一行的统一基线下方绘制，按音符横向居中。
- 关键参数
  - 弦数、弦间距、品位单元宽度、整体边距、行间距、歌词偏移量等常量控制布局。
- 性能与优化
  - 使用抗锯齿与文本渲染提示提升视觉质量。
  - 逐行绘制，避免不必要的重绘。
  - 可进一步优化：缓存字体度量、批量绘制、延迟加载字体资源。
- 错误处理
  - 对空数据抛出异常，防止生成空白或错误图像。

```mermaid
flowchart TD
Start(["开始渲染"]) --> Load["读取并解析 JSON"]
Load --> Validate{"数据有效？"}
Validate --> |否| ThrowErr["抛出异常"]
Validate --> |是| CalcSize["计算行宽与画布尺寸"]
CalcSize --> InitImg["创建位图并获取 Graphics"]
InitImg --> LoopLines{"遍历每一行"}
LoopLines --> DrawStrings["绘制四线谱网格"]
DrawStrings --> LoopItems{"遍历该行音符项"}
LoopItems --> DrawFret["绘制品号"]
DrawFret --> DrawLyric{"有歌词？"}
DrawLyric --> |是| DrawLineLyric["在统一歌词基线绘制歌词"]
DrawLyric --> |否| NextItem["下一个音符项"]
DrawLineLyric --> NextItem
NextItem --> LoopItems
LoopItems --> EndLine["结束该行"]
EndLine --> LoopLines
LoopLines --> Done["完成渲染"]
ThrowErr --> End([结束])
Done --> Save["保存为图片文件"]
Save --> End
```

图表来源
- [SheetMusicRenderer.cs](file://UkuleleEditor/SheetMusicRenderer.cs#L1-L145)

章节来源
- [SheetMusicRenderer.cs](file://UkuleleEditor/SheetMusicRenderer.cs#L1-L145)

### 应用入口：Program 与 MainForm
- Program
  - 设置应用配置并启动主窗体。
- MainForm
  - 初始化窗体标题，展示版本信息。
  - 调用渲染器加载测试数据并保存为图片文件，用于验证渲染流程。

章节来源
- [Program.cs](file://UkuleleEditor/Program.cs#L1-L17)
- [MainForm.cs](file://UkuleleEditor/MainForm.cs#L1-L24)
- [MainForm.Designer.cs](file://UkuleleEditor/MainForm.Designer.cs#L1-L40)

## 依赖关系分析
- 内部依赖
  - SheetMusicRenderer 依赖 SheetMusicItem 数据模型。
  - MainForm 依赖 SheetMusicRenderer 以执行渲染。
- 外部依赖
  - System.Text.Json：用于 JSON 解析。
  - System.Drawing：用于绘图与位图操作。
  - Windows Forms：用于窗体与应用生命周期管理。
- 项目配置
  - 使用 Newtonsoft.Json 包引用，但当前渲染逻辑使用 System.Text.Json；存在潜在一致性问题，建议统一。

```mermaid
graph LR
Program["Program"] --> MainForm["MainForm"]
MainForm --> Renderer["SheetMusicRenderer"]
Renderer --> Model["SheetMusicItem"]
Renderer --> Json["System.Text.Json"]
Renderer --> Gfx["System.Drawing"]
MainForm --> WinForms["Windows Forms"]
```

图表来源
- [UkuleleEditor.csproj](file://UkuleleEditor/UkuleleEditor.csproj#L1-L24)
- [MainForm.cs](file://UkuleleEditor/MainForm.cs#L1-L24)
- [SheetMusicRenderer.cs](file://UkuleleEditor/SheetMusicRenderer.cs#L1-L145)
- [SheetMusicItem.cs](file://UkuleleEditor/SheetMusicItem.cs#L1-L50)

章节来源
- [UkuleleEditor.csproj](file://UkuleleEditor/UkuleleEditor.csproj#L1-L24)

## 性能考虑
- 绘图质量
  - 抗锯齿与文本渲染提示已启用，保证输出清晰度。
- 绘制策略
  - 逐行绘制，避免重复计算；字号与字体资源可复用以减少开销。
- 数据规模
  - 当前实现按音符线性处理，适合中小规模乐谱；大规模乐谱建议分页或虚拟化渲染。
- I/O 与序列化
  - JSON 读取与反序列化为一次性操作；可考虑缓存与预热以降低首帧延迟。

## 故障排除指南
- 渲染失败或无输出
  - 检查测试 JSON 是否存在且格式正确。
  - 确认渲染器未抛出“谱面数据为空”的异常。
- 图片未生成
  - 确认渲染流程已执行并保存目标路径可写。
- 版本信息显示异常
  - 若程序集版本不可用，窗体会回退到产品版本；确保构建配置正确。
- 字体与字符显示问题
  - 默认字体可能在某些系统上缺失；可调整字体或提供字体资源。

章节来源
- [MainForm.cs](file://UkuleleEditor/MainForm.cs#L1-L24)
- [SheetMusicRenderer.cs](file://UkuleleEditor/SheetMusicRenderer.cs#L1-L145)
- [test.json](file://UkuleleEditor/Tests/test.json#L1-L112)

## 结论
本项目实现了尤克里里乐谱的基础渲染能力：通过 JSON 描述乐谱行与音符项，渲染器绘制四线谱网格、品位数字与统一歌词基线，并输出为图片。当前版本聚焦核心流程验证，后续可扩展为可视化的编辑界面、导入导出多种格式、支持更多视觉样式与交互操作。

## 附录
- 测试数据说明
  - 示例 JSON 包含两行音符，每行包含多个音符项，每个音符项包含弦号、品号与可选歌词。
- 使用建议
  - 将自定义乐谱按示例 JSON 结构组织，放置于 Tests 目录以便调试。
  - 如需扩展功能，可在 MainForm 中增加用户交互控件，并将渲染结果绑定到可视化面板。

章节来源
- [test.json](file://UkuleleEditor/Tests/test.json#L1-L112)